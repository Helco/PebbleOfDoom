# Renderer Math

## Basics

We define the cross-product of two two-dimensional vectors as followed:

<a href="https://www.codecogs.com/eqnedit.php?latex=\vec{v_1}&space;=&space;\begin{pmatrix}&space;x_1&space;\\&space;y_1&space;\end{pmatrix},&space;\vec{v_2}&space;=&space;\begin{pmatrix}&space;x_2&space;\\&space;y_2&space;\end{pmatrix}&space;and&space;A&space;=&space;\begin{bmatrix}&space;x_1&space;&&space;y_1&space;\\&space;x_2&space;&&space;y_2&space;\end{bmatrix}&space;\\&space;\vec{v1}&space;\times&space;\vec{v2}&space;=&space;\det(A)&space;=&space;x_1&space;y_2&space;-&space;y_1&space;x_2" target="_blank"><img src="https://latex.codecogs.com/svg.latex?\vec{v_1}&space;=&space;\begin{pmatrix}&space;x_1&space;\\&space;y_1&space;\end{pmatrix},&space;\vec{v_2}&space;=&space;\begin{pmatrix}&space;x_2&space;\\&space;y_2&space;\end{pmatrix}&space;and&space;A&space;=&space;\begin{bmatrix}&space;x_1&space;&&space;y_1&space;\\&space;x_2&space;&&space;y_2&space;\end{bmatrix}&space;\\&space;\vec{v1}&space;\times&space;\vec{v2}&space;=&space;\det(A)&space;=&space;x_1&space;y_2&space;-&space;y_1&space;x_2" title="\vec{v_1} = \begin{pmatrix} x_1 \\ y_1 \end{pmatrix}, \vec{v_2} = \begin{pmatrix} x_2 \\ y_2 \end{pmatrix} and A = \begin{bmatrix} x_1 & y_1 \\ x_2 & y_2 \end{bmatrix} \\ \vec{v1} \times \vec{v2} = \det(A) = x_1 y_2 - y_1 x_2" /></a>

Also the intersection of two lines A and B (calculated with Cramer's rule) is:

<a href="https://www.codecogs.com/eqnedit.php?latex=A&space;=&space;\begin{bmatrix}&space;\vec{a_1}&space;&&space;\vec{a_2}&space;\end{bmatrix}&space;^T&space;~~~&space;B&space;=&space;\begin{bmatrix}&space;\vec{b_1}&space;&&space;\vec{b_2}&space;\end{bmatrix}&space;^T&space;\\&space;i_x&space;=&space;\det(\begin{bmatrix}&space;\det(A)&space;&&space;\det(B)&space;\\&space;x_a_1&space;-&space;x_a_2&space;&&space;x_b_1&space;-&space;x_b_2&space;\end{bmatrix})&space;\\&space;i_y&space;=&space;\det(\begin{bmatrix}&space;\det(A)&space;&&space;\det(B)&space;\\&space;y_a_1&space;-&space;y_a_2&space;&&space;y_b_1&space;-&space;y_b_2&space;\end{bmatrix})&space;\\&space;d&space;=&space;(\vec{a_1}&space;-&space;\vec{a_2})&space;\times&space;(\vec{b_1}&space;-&space;\vec{b_2})&space;\\&space;\text{intersect}(A,&space;B)&space;=&space;\begin{pmatrix}&space;i_x&space;\\&space;i_y&space;\end{pmatrix}&space;*&space;\frac{1}{d}" target="_blank"><img src="https://latex.codecogs.com/svg.latex?A&space;=&space;\begin{bmatrix}&space;\vec{a_1}&space;&&space;\vec{a_2}&space;\end{bmatrix}&space;^T&space;~~~&space;B&space;=&space;\begin{bmatrix}&space;\vec{b_1}&space;&&space;\vec{b_2}&space;\end{bmatrix}&space;^T&space;\\&space;i_x&space;=&space;\det(\begin{bmatrix}&space;\det(A)&space;&&space;\det(B)&space;\\&space;x_a_1&space;-&space;x_a_2&space;&&space;x_b_1&space;-&space;x_b_2&space;\end{bmatrix})&space;\\&space;i_y&space;=&space;\det(\begin{bmatrix}&space;\det(A)&space;&&space;\det(B)&space;\\&space;y_a_1&space;-&space;y_a_2&space;&&space;y_b_1&space;-&space;y_b_2&space;\end{bmatrix})&space;\\&space;d&space;=&space;(\vec{a_1}&space;-&space;\vec{a_2})&space;\times&space;(\vec{b_1}&space;-&space;\vec{b_2})&space;\\&space;\text{intersect}(A,&space;B)&space;=&space;\begin{pmatrix}&space;i_x&space;\\&space;i_y&space;\end{pmatrix}&space;*&space;\frac{1}{d}" title="A = \begin{bmatrix} \vec{a_1} & \vec{a_2} \end{bmatrix} ^T ~~~ B = \begin{bmatrix} \vec{b_1} & \vec{b_2} \end{bmatrix} ^T \\ i_x = \det(\begin{bmatrix} \det(A) & \det(B) \\ x_a_1 - x_a_2 & x_b_1 - x_b_2 \end{bmatrix}) \\ i_y = \det(\begin{bmatrix} \det(A) & \det(B) \\ y_a_1 - y_a_2 & y_b_1 - y_b_2 \end{bmatrix}) \\ d = (\vec{a_1} - \vec{a_2}) \times (\vec{b_1} - \vec{b_2}) \\ \text{intersect}(A, B) = \begin{pmatrix} i_x \\ i_y \end{pmatrix} * \frac{1}{d}" /></a>

If _d = 0_ then the two lines are parallel and no intersection point exists. Furthermore to find out where the intersection point on a line segment A lies we can calculate:

<a href="https://www.codecogs.com/eqnedit.php?latex=r_A&space;=&space;\frac{i_x&space;-&space;a_x_1}{a_x_2&space;-&space;a_x_1}" target="_blank"><img src="https://latex.codecogs.com/svg.latex?r_A&space;=&space;\frac{i_x&space;-&space;a_x_1}{a_x_2&space;-&space;a_x_1}" title="r_A = \frac{i_x - a_x_1}{a_x_2 - a_x_1}" /></a>

If the line corners are ordered (that is increasing by x-coordinate) and <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;0&space;\leq&space;r_A&space;\leq&space;1" target="_blank"><img src="https://latex.codecogs.com/svg.latex?\inline&space;0&space;\leq&space;r_A&space;\leq&space;1" title="0 \leq r_A \leq 1" /></a> then the intersection point lies in the line segment. 

## Camera parameters

For the camera projection we can define several parameters and consequent formulas:

<a href="https://www.codecogs.com/eqnedit.php?latex=\text{Camera&space;position}&space;~&space;\vec{p}&space;=&space;\begin{pmatrix}&space;p_x&space;\\&space;p_y&space;\end{pmatrix}&space;\\&space;\text{Camera&space;angle}&space;~&space;\lambda&space;~&space;\text{and&space;thus&space;camera&space;look&space;vector}&space;~&space;\vec{l}&space;=&space;\begin{pmatrix}&space;\cos{\lambda}&space;\\&space;\sin{\lambda}&space;\end{pmatrix}&space;\\&space;\text{Camera&space;horizontal&space;field&space;of&space;view}&space;~&space;\Theta&space;~&space;\text{with}&space;~&space;\theta&space;=&space;\frac{\Theta}{2}&space;\\&space;\text{The&space;near/far&space;plane&space;distance}&space;~&space;n_z&space;\text{/}&space;f_z&space;\\&space;\text{The&space;horizontal&space;near/far&space;plane&space;shift}&space;~&space;n_x&space;=&space;\frac{n_z}{cos(\theta)}&space;~~&space;f_x&space;=&space;\frac{f_z}{cos(\theta}&space;\\&space;\text{The&space;FOV&space;boundary&space;lines}&space;~&space;V_l&space;=&space;\begin{bmatrix}&space;-n_x&space;&&&space;n_z&space;\\&space;-f_x&space;&&&space;f_z&space;\end{bmatrix}&space;~&space;\text{and}&space;~&space;V_r&space;=&space;\begin{bmatrix}&space;n_x&space;&&&space;n_z&space;\\&space;f_x&space;&&&space;f_z&space;\end{bmatrix}&space;\\&space;\text{The&space;screen&space;boundaries&space;from}&space;~&space;\begin{pmatrix}&space;-s_w&space;\\&space;-s_h&space;\end{pmatrix}&space;~&space;\text{to}&space;~&space;\begin{pmatrix}&space;s_w&space;\\&space;s_h&space;\end{pmatrix}&space;\\&space;\text{Projection&space;scale}&space;~&space;S&space;=&space;\frac{s_w&space;*&space;\cos(\theta)}{\tan(\theta)}" target="_blank"><img src="https://latex.codecogs.com/svg.latex?\text{Camera&space;position}&space;~&space;\vec{p}&space;=&space;\begin{pmatrix}&space;p_x&space;\\&space;p_y&space;\end{pmatrix}&space;\\&space;\text{Camera&space;angle}&space;~&space;\lambda&space;~&space;\text{and&space;thus&space;camera&space;look&space;vector}&space;~&space;\vec{l}&space;=&space;\begin{pmatrix}&space;\cos{\lambda}&space;\\&space;\sin{\lambda}&space;\end{pmatrix}&space;\\&space;\text{Camera&space;horizontal&space;field&space;of&space;view}&space;~&space;\Theta&space;~&space;\text{with}&space;~&space;\theta&space;=&space;\frac{\Theta}{2}&space;\\&space;\text{The&space;near/far&space;plane&space;distance}&space;~&space;n_z&space;\text{/}&space;f_z&space;\\&space;\text{The&space;horizontal&space;near/far&space;plane&space;shift}&space;~&space;n_x&space;=&space;\frac{n_z}{cos(\theta)}&space;~~&space;f_x&space;=&space;\frac{f_z}{cos(\theta}&space;\\&space;\text{The&space;FOV&space;boundary&space;lines}&space;~&space;V_l&space;=&space;\begin{bmatrix}&space;-n_x&space;&&&space;n_z&space;\\&space;-f_x&space;&&&space;f_z&space;\end{bmatrix}&space;~&space;\text{and}&space;~&space;V_r&space;=&space;\begin{bmatrix}&space;n_x&space;&&&space;n_z&space;\\&space;f_x&space;&&&space;f_z&space;\end{bmatrix}&space;\\&space;\text{The&space;screen&space;boundaries&space;from}&space;~&space;\begin{pmatrix}&space;-s_w&space;\\&space;-s_h&space;\end{pmatrix}&space;~&space;\text{to}&space;~&space;\begin{pmatrix}&space;s_w&space;\\&space;s_h&space;\end{pmatrix}&space;\\&space;\text{Projection&space;scale}&space;~&space;S&space;=&space;\frac{s_w&space;*&space;\cos(\theta)}{\tan(\theta)}" title="\text{Camera position} ~ \vec{p} = \begin{pmatrix} p_x \\ p_y \end{pmatrix} \\ \text{Camera angle} ~ \lambda ~ \text{and thus camera look vector} ~ \vec{l} = \begin{pmatrix} \cos{\lambda} \\ \sin{\lambda} \end{pmatrix} \\ \text{Camera horizontal field of view} ~ \Theta ~ \text{with} ~ \theta = \frac{\Theta}{2} \\ \text{The near/far plane distance} ~ n_z \text{/} f_z \\ \text{The horizontal near/far plane shift} ~ n_x = \frac{n_z}{cos(\theta)} ~~ f_x = \frac{f_z}{cos(\theta} \\ \text{The FOV boundary lines} ~ V_l = \begin{bmatrix} -n_x && n_z \\ -f_x && f_z \end{bmatrix} ~ \text{and} ~ V_r = \begin{bmatrix} n_x && n_z \\ f_x && f_z \end{bmatrix} \\ \text{The screen boundaries from} ~ \begin{pmatrix} -s_w \\ -s_h \end{pmatrix} ~ \text{to} ~ \begin{pmatrix} s_w \\ s_h \end{pmatrix} \\ \text{Projection scale} ~ S = \frac{s_w * \cos(\theta)}{\tan(\theta)}" /></a>

## Wall rendering

The geometry of a single wall consists of:

<a href="https://www.codecogs.com/eqnedit.php?latex=\\&space;\text{The&space;corner&space;positions&space;(world-space):}&space;~&space;\vec{w_1},&space;\vec{w_2}&space;\\&space;\text{The&space;wall&space;height:}&space;~&space;h_w&space;\\&space;\text{The&space;vertical&space;offset:}&space;~&space;y_w" target="_blank"><img src="https://latex.codecogs.com/svg.latex?\\&space;\text{The&space;corner&space;positions&space;(world-space):}&space;~&space;\vec{w_1},&space;\vec{w_2}&space;\\&space;\text{The&space;wall&space;height:}&space;~&space;h_w&space;\\&space;\text{The&space;vertical&space;offset:}&space;~&space;y_w" title="\\ \text{The corner positions (world-space):} ~ \vec{w_1}, \vec{w_2} \\ \text{The wall height:} ~ h_w \\ \text{The vertical offset:} ~ y_w" /></a>

First we transform the world-coordinates of the two wall corners into camera space:

<a href="https://www.codecogs.com/eqnedit.php?latex=\vec{t_1}&space;=&space;\begin{bmatrix}&space;\cos(\lambda)&space;&&space;\sin(\lambda)&space;\\&space;\sin(\lambda)&space;&&space;-cos(\lambda)&space;\end{bmatrix}&space;*&space;(\vec{w_1}&space;-&space;\vec{p})" target="_blank"><img src="https://latex.codecogs.com/svg.latex?\vec{t_1}&space;=&space;\begin{bmatrix}&space;\cos(\lambda)&space;&&space;\sin(\lambda)&space;\\&space;\sin(\lambda)&space;&&space;-cos(\lambda)&space;\end{bmatrix}&space;*&space;(\vec{w_1}&space;-&space;\vec{p})" title="\vec{t_1} = \begin{bmatrix} \cos(\lambda) & \sin(\lambda) \\ \sin(\lambda) & -cos(\lambda) \end{bmatrix} * (\vec{w_1} - \vec{p})" /></a>

Then we find the intersection points of the wall with the FOV boundary lines, if these intersections lie between the near and far plane the wall is clipped at that point. If both transformed and clipped wall corners are either less than zero or less than the intersection point in front of the camera (if there is such an intersection point) then the wall lies completly outside of the field of view and can be discarded.

Finally we can apply the perspective projection to the horizontal position of the wall by dividing through the _z_ component and using the projection scale factor. Also we can calculate the vertical position and height of the wall:

<a href="https://www.codecogs.com/eqnedit.php?latex=\\&space;x_1&space;=&space;\frac{-x_t_1&space;*&space;S}{z_t_1}&space;\\&space;y_1_l&space;=&space;s_h&space;*&space;\frac{-0.5&space;h_w&space;-&space;y_w}{z_t_1}&space;\\&space;y_1_h&space;=&space;s_h&space;*&space;\frac{0.5&space;h_w&space;-&space;y_w}{z_t_1}&space;\\" target="_blank"><img src="https://latex.codecogs.com/svg.latex?\\&space;x_1&space;=&space;\frac{-x_t_1&space;*&space;S}{z_t_1}&space;\\&space;y_1_l&space;=&space;s_h&space;*&space;\frac{-0.5&space;h_w&space;-&space;y_w}{z_t_1}&space;\\&space;y_1_h&space;=&space;s_h&space;*&space;\frac{0.5&space;h_w&space;-&space;y_w}{z_t_1}&space;\\" title="\\ x_1 = \frac{-x_t_1 * S}{z_t_1} \\ y_1_l = s_h * \frac{-0.5 h_w - y_w}{z_t_1} \\ y_1_h = s_h * \frac{0.5 h_w - y_w}{z_t_1} \\" /></a>
